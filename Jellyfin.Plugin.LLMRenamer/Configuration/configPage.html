<!DOCTYPE html>
<html>
<head>
    <title>LLM File Renamer</title>
    <style>
        .model-card {
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 4px;
            padding: 1em;
            margin-bottom: 0.5em;
            background: rgba(0,0,0,0.2);
        }
        .model-card.active {
            border-color: #52b54b;
            background: rgba(82, 181, 75, 0.1);
        }
        .model-card h4 {
            margin: 0 0 0.5em 0;
        }
        .model-card p {
            margin: 0.25em 0;
            font-size: 0.9em;
            opacity: 0.8;
        }
        .model-actions {
            margin-top: 0.75em;
            display: flex;
            gap: 0.5em;
            flex-wrap: wrap;
        }
        .progress-container {
            margin-top: 0.75em;
        }
        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background: #52b54b;
            transition: width 0.25s ease-out;
            border-radius: 4px;
        }
        .progress-bar-fill.error {
            background: #d32f2f;
        }
        .progress-text {
            font-size: 0.85em;
            margin-top: 0.5em;
            opacity: 0.9;
        }
        .progress-eta {
            font-size: 0.8em;
            opacity: 0.7;
        }
        .section-divider {
            border-top: 1px solid rgba(255,255,255,0.1);
            margin: 1.5em 0;
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 0.5em;
        }
        .status-indicator.loaded { background: #52b54b; }
        .status-indicator.unloaded { background: #f2a83b; }
        .status-indicator.error { background: #d32f2f; }
        .badge {
            display: inline-block;
            padding: 0.2em 0.6em;
            border-radius: 3px;
            font-size: 0.75em;
            background: rgba(255,255,255,0.1);
            margin-left: 0.5em;
        }
        .badge.recommended {
            background: rgba(82, 181, 75, 0.3);
            color: #52b54b;
        }
        .badge.downloading {
            background: rgba(33, 150, 243, 0.3);
            color: #2196f3;
        }
        .btn-cancel {
            background: #d32f2f !important;
        }
        .native-status {
            padding: 1em;
            border-radius: 4px;
            margin-bottom: 1em;
        }
        .native-status.installed {
            background: rgba(82, 181, 75, 0.1);
            border: 1px solid rgba(82, 181, 75, 0.3);
        }
        .native-status.missing {
            background: rgba(242, 168, 59, 0.1);
            border: 1px solid rgba(242, 168, 59, 0.3);
        }
    </style>
</head>
<body>
    <div id="LLMRenamerConfigPage" data-role="page" class="page type-interior pluginConfigurationPage"
         data-require="emby-input,emby-button,emby-checkbox,emby-select">
        <div data-role="content">
            <div class="content-primary">
                <form id="LLMRenamerConfigForm">
                    <div class="sectionTitleContainer flex align-items-center">
                        <h2 class="sectionTitle">LLM File Renamer Settings</h2>
                    </div>

                    <!-- Status Section -->
                    <div class="verticalSection" id="statusSection">
                        <h3 class="sectionTitle">Status</h3>
                        <div id="modelStatus">
                            <span class="status-indicator unloaded"></span>
                            <span id="statusText">Checking...</span>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Native Libraries Section -->
                    <div class="verticalSection" id="nativeSection">
                        <h3 class="sectionTitle">Native Libraries</h3>
                        <div id="nativeStatus" class="native-status missing">
                            <p><strong>Platform:</strong> <span id="nativePlatform">Detecting...</span></p>
                            <p><strong>Status:</strong> <span id="nativeStatusText">Checking...</span></p>
                            <p id="nativePathInfo" style="display:none; font-size: 0.9em; opacity: 0.8;">
                                <strong>Location:</strong> <span id="nativePath"></span>
                            </p>
                            <div class="model-actions" id="nativeActions" style="display:none;">
                                <button is="emby-button" type="button" class="raised" id="btnDownloadNative">
                                    <span>Download Native Libraries</span>
                                </button>
                            </div>
                        </div>
                        <p style="opacity: 0.7; font-size: 0.85em;">
                            LLM inference requires native llama.cpp libraries for your platform.
                        </p>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Download Progress Banner -->
                    <div class="verticalSection" id="globalDownloadProgress" style="display: none;">
                        <h3 class="sectionTitle">Downloading Model</h3>
                        <div class="model-card">
                            <h4 id="downloadingModelName">...</h4>
                            <div class="progress-bar">
                                <div class="progress-bar-fill" id="globalProgressFill" style="width: 0%"></div>
                            </div>
                            <div class="progress-text" id="globalProgressText">Starting...</div>
                            <div class="progress-eta" id="globalProgressEta"></div>
                            <div class="model-actions" style="margin-top: 1em;">
                                <button is="emby-button" type="button" class="raised btn-cancel" id="btnCancelDownload">
                                    <span>Cancel Download</span>
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Model Download Section -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Download Model</h3>
                        <p style="opacity: 0.8; margin-bottom: 1em;">
                            Select a model to download. Smaller models are faster but less accurate.
                        </p>

                        <div id="availableModels">
                            <!-- Models will be loaded here -->
                        </div>

                        <div class="section-divider"></div>

                        <h4>Custom Model Download</h4>
                        <div class="inputContainer">
                            <label class="inputLabel" for="txtCustomUrl">Model URL (direct link to .gguf file)</label>
                            <input is="emby-input" type="url" id="txtCustomUrl" placeholder="https://huggingface.co/.../model.gguf" />
                        </div>
                        <div class="inputContainer">
                            <label class="inputLabel" for="txtCustomFilename">Save As</label>
                            <input is="emby-input" type="text" id="txtCustomFilename" placeholder="custom-model.gguf" />
                        </div>
                        <button is="emby-button" type="button" class="raised" id="btnDownloadCustom">
                            <span>Download Custom Model</span>
                        </button>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Local Models Section -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Installed Models</h3>
                        <div id="localModels">
                            <p style="opacity: 0.6;">No models installed yet.</p>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Manual Configuration -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Manual Configuration</h3>

                        <div class="inputContainer">
                            <label class="inputLabel" for="txtModelPath">Model Path (GGUF file)</label>
                            <input is="emby-input" type="text" id="txtModelPath" name="ModelPath"
                                   placeholder="/path/to/model.gguf" />
                            <div class="fieldDescription">
                                Full path to your GGUF model file. Use the download section above or specify manually.
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel" for="txtModelName">Model Name (for reference)</label>
                            <input is="emby-input" type="text" id="txtModelName" name="ModelName" />
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel" for="numGpuLayers">GPU Layers</label>
                            <input is="emby-input" type="number" id="numGpuLayers" name="GpuLayerCount"
                                   min="0" max="100" step="1" />
                            <div class="fieldDescription">
                                Number of layers to offload to GPU. Set to 0 for CPU-only inference.
                            </div>
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel" for="numContextSize">Context Size</label>
                            <input is="emby-input" type="number" id="numContextSize" name="ContextSize"
                                   min="512" max="8192" step="256" />
                        </div>

                        <div class="inputContainer">
                            <label class="inputLabel" for="numMaxTokens">Max Tokens</label>
                            <input is="emby-input" type="number" id="numMaxTokens" name="MaxTokens"
                                   min="64" max="1024" step="32" />
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Rename Settings -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Rename Settings</h3>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkPreviewOnly" name="PreviewOnly" />
                                <span>Preview Only (Dry Run)</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                When enabled, suggestions will be logged but no files will be renamed.
                            </div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkEnableAutoRename" name="EnableAutoRename" />
                                <span>Enable Auto-Rename on Library Scan</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                Automatically rename new files when they are added to the library.
                            </div>
                        </div>

                        <div class="checkboxContainer checkboxContainer-withDescription">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkRenameDirectories" name="RenameDirectories" />
                                <span>Rename Parent Directories</span>
                            </label>
                            <div class="fieldDescription checkboxFieldDescription">
                                Also rename parent directories to follow Jellyfin naming conventions (e.g., 'Movie Title (Year)/'). Uses metadata, not LLM.
                            </div>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <h3 class="sectionTitle">Media Types</h3>

                        <div class="checkboxContainer">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkRenameMovies" name="RenameMovies" />
                                <span>Rename Movies</span>
                            </label>
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkRenameEpisodes" name="RenameEpisodes" />
                                <span>Rename TV Episodes</span>
                            </label>
                        </div>

                        <div class="checkboxContainer">
                            <label>
                                <input is="emby-checkbox" type="checkbox" id="chkRenameMusic" name="RenameMusic" />
                                <span>Rename Music Files</span>
                            </label>
                        </div>
                    </div>

                    <div class="section-divider"></div>

                    <!-- Advanced -->
                    <div class="verticalSection">
                        <h3 class="sectionTitle">Advanced</h3>

                        <div class="inputContainer">
                            <label class="inputLabel" for="txtCustomPrompt">Custom Prompt Additions</label>
                            <textarea is="emby-input" id="txtCustomPrompt" name="CustomPromptAdditions"
                                      rows="4" style="width: 100%;"></textarea>
                            <div class="fieldDescription">
                                Additional instructions to include in the LLM prompt.
                            </div>
                        </div>
                    </div>

                    <div class="verticalSection">
                        <button is="emby-button" type="submit" class="raised button-submit block">
                            <span>Save</span>
                        </button>
                    </div>
                </form>

                <div class="section-divider"></div>

                <!-- Test Section -->
                <div class="verticalSection">
                    <h3 class="sectionTitle">Test Renaming</h3>
                    <p style="opacity: 0.8;">Test the LLM with a sample filename.</p>

                    <div class="inputContainer">
                        <label class="inputLabel" for="txtTestFilename">Test Filename</label>
                        <input is="emby-input" type="text" id="txtTestFilename"
                               placeholder="The.Matrix.1999.1080p.BluRay.x264-GROUP.mkv" />
                    </div>

                    <button is="emby-button" type="button" class="raised" id="btnTest">
                        <span>Test Rename</span>
                    </button>

                    <div id="testResult" style="margin-top: 1em; display: none;">
                        <p><strong>Original:</strong> <span id="testOriginal"></span></p>
                        <p><strong>Suggested:</strong> <span id="testSuggested"></span></p>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            var LLMRenamerConfig = {
                pluginUniqueId: 'a1b2c3d4-e5f6-7890-abcd-ef1234567890'
            };

            var progressPollingInterval = null;
            var currentDownloadingModelId = null;

            function formatBytes(bytes) {
                if (bytes === 0) return '0 B';
                var k = 1024;
                var sizes = ['B', 'KB', 'MB', 'GB'];
                var i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
            }

            function formatEta(seconds) {
                if (!seconds || seconds <= 0) return '';
                if (seconds < 60) return Math.round(seconds) + 's remaining';
                if (seconds < 3600) return Math.round(seconds / 60) + 'm remaining';
                return Math.round(seconds / 3600) + 'h ' + Math.round((seconds % 3600) / 60) + 'm remaining';
            }

            function loadStatus() {
                ApiClient.getJSON(ApiClient.getUrl('LLMRenamer/Status')).then(function(status) {
                    var indicator = document.querySelector('#modelStatus .status-indicator');
                    var text = document.getElementById('statusText');

                    if (status.IsModelLoaded) {
                        indicator.className = 'status-indicator loaded';
                        text.textContent = 'Model loaded: ' + status.ModelName;
                    } else if (status.ModelPath) {
                        indicator.className = 'status-indicator unloaded';
                        text.textContent = 'Model configured (not loaded): ' + status.ModelName;
                    } else {
                        indicator.className = 'status-indicator error';
                        text.textContent = 'No model configured - download one below';
                    }
                });
            }

            function loadAvailableModels() {
                ApiClient.getJSON(ApiClient.getUrl('LLMRenamer/Models/Available')).then(function(models) {
                    ApiClient.getJSON(ApiClient.getUrl('LLMRenamer/Models/Local')).then(function(localModels) {
                        var container = document.getElementById('availableModels');
                        var localFilenames = localModels.map(function(m) { return m.Filename.toLowerCase(); });

                        container.innerHTML = models.map(function(model, index) {
                            var isDownloaded = localFilenames.indexOf(model.Filename.toLowerCase()) >= 0;
                            var isFirst = index === 0;
                            var isCurrentlyDownloading = currentDownloadingModelId === model.Id;

                            return '<div class="model-card" id="model-card-' + model.Id + '">' +
                                '<h4>' + model.DisplayName +
                                (isFirst ? '<span class="badge recommended">Recommended</span>' : '') +
                                (isDownloaded ? '<span class="badge">Installed</span>' : '') +
                                (isCurrentlyDownloading ? '<span class="badge downloading">Downloading...</span>' : '') +
                                '</h4>' +
                                '<p>' + model.Description + '</p>' +
                                '<p>Size: ~' + formatBytes(model.ExpectedSize) + '</p>' +
                                '<div class="model-actions">' +
                                (isDownloaded ?
                                    '<button is="emby-button" type="button" class="raised" onclick="setActiveModel(\'' + model.Filename + '\')">Use This Model</button>' :
                                    (isCurrentlyDownloading ?
                                        '<button is="emby-button" type="button" class="raised" disabled><span>Downloading...</span></button>' :
                                        '<button is="emby-button" type="button" class="raised button-submit" onclick="downloadModel(\'' + model.Id + '\')">Download</button>'
                                    )
                                ) +
                                '</div>' +
                                '</div>';
                        }).join('');
                    });
                });
            }

            function loadLocalModels() {
                ApiClient.getPluginConfiguration(LLMRenamerConfig.pluginUniqueId).then(function(config) {
                    ApiClient.getJSON(ApiClient.getUrl('LLMRenamer/Models/Local')).then(function(models) {
                        var container = document.getElementById('localModels');

                        if (models.length === 0) {
                            container.innerHTML = '<p style="opacity: 0.6;">No models installed yet. Download one above.</p>';
                            return;
                        }

                        container.innerHTML = models.map(function(model) {
                            var isActive = config.ModelPath && config.ModelPath.endsWith(model.Filename);

                            return '<div class="model-card' + (isActive ? ' active' : '') + '">' +
                                '<h4>' + model.DisplayName + (isActive ? ' (Active)' : '') + '</h4>' +
                                '<p>Size: ' + formatBytes(model.Size) + '</p>' +
                                '<p style="word-break: break-all;">Path: ' + model.FullPath + '</p>' +
                                '<div class="model-actions">' +
                                (!isActive ? '<button is="emby-button" type="button" class="raised" onclick="setActiveModel(\'' + model.Filename + '\')">Use This Model</button>' : '') +
                                '<button is="emby-button" type="button" class="raised" onclick="deleteModel(\'' + model.Filename + '\')">Delete</button>' +
                                '</div>' +
                                '</div>';
                        }).join('');
                    });
                });
            }

            function updateProgressUI(progress) {
                var container = document.getElementById('globalDownloadProgress');
                var fill = document.getElementById('globalProgressFill');
                var text = document.getElementById('globalProgressText');
                var eta = document.getElementById('globalProgressEta');
                var name = document.getElementById('downloadingModelName');

                if (!progress || !progress.IsDownloading) {
                    // Check if completed or failed
                    if (progress && progress.State) {
                        if (progress.State === 'Completed') {
                            container.style.display = 'block';
                            name.textContent = progress.DisplayName || 'Model';
                            fill.style.width = '100%';
                            fill.classList.remove('error');
                            text.textContent = 'Download complete!';
                            eta.textContent = '';

                            // Clear after a moment and refresh
                            setTimeout(function() {
                                ApiClient.ajax({ type: 'POST', url: ApiClient.getUrl('LLMRenamer/Models/ClearDownloadStatus') });
                                container.style.display = 'none';
                                currentDownloadingModelId = null;
                                loadAvailableModels();
                                loadLocalModels();
                                loadStatus();
                                loadNativeStatus();
                                loadFormFromConfig();
                                stopProgressPolling();
                            }, 2000);
                            return;
                        } else if (progress.State === 'Failed' || progress.State === 'Cancelled') {
                            container.style.display = 'block';
                            name.textContent = progress.DisplayName || 'Model';
                            fill.style.width = '100%';
                            fill.classList.add('error');
                            text.textContent = progress.Status || 'Download failed';
                            eta.textContent = '';

                            setTimeout(function() {
                                ApiClient.ajax({ type: 'POST', url: ApiClient.getUrl('LLMRenamer/Models/ClearDownloadStatus') });
                                container.style.display = 'none';
                                currentDownloadingModelId = null;
                                loadAvailableModels();
                                stopProgressPolling();
                            }, 3000);
                            return;
                        }
                    }

                    container.style.display = 'none';
                    currentDownloadingModelId = null;
                    return;
                }

                container.style.display = 'block';
                currentDownloadingModelId = progress.ModelId;
                name.textContent = progress.DisplayName || progress.ModelId;
                fill.style.width = progress.Percentage + '%';
                fill.classList.remove('error');
                text.textContent = progress.Status || 'Downloading...';
                eta.textContent = formatEta(progress.EstimatedSecondsRemaining);
            }

            function startProgressPolling() {
                if (progressPollingInterval) return;

                progressPollingInterval = setInterval(function() {
                    ApiClient.getJSON(ApiClient.getUrl('LLMRenamer/Models/DownloadProgress')).then(function(progress) {
                        updateProgressUI(progress);

                        if (!progress || !progress.IsDownloading) {
                            if (!progress || !progress.State || progress.State === 'Completed' || progress.State === 'Failed' || progress.State === 'Cancelled') {
                                // Will be handled in updateProgressUI
                            }
                        }
                    }).catch(function() {
                        stopProgressPolling();
                    });
                }, 500);
            }

            function stopProgressPolling() {
                if (progressPollingInterval) {
                    clearInterval(progressPollingInterval);
                    progressPollingInterval = null;
                }
            }

            function downloadModel(modelId) {
                currentDownloadingModelId = modelId;
                loadAvailableModels();

                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl('LLMRenamer/Models/Download/' + modelId)
                }).then(function() {
                    startProgressPolling();
                }).catch(function(err) {
                    currentDownloadingModelId = null;
                    loadAvailableModels();
                    Dashboard.alert('Failed to start download: ' + (err.message || 'Unknown error'));
                });
            }

            function setActiveModel(filename) {
                Dashboard.showLoadingMsg();
                var statusText = document.getElementById('statusText');
                var indicator = document.querySelector('#modelStatus .status-indicator');
                indicator.className = 'status-indicator unloaded';
                statusText.textContent = 'Loading model...';

                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl('LLMRenamer/Models/SetActive/' + encodeURIComponent(filename))
                }).then(function() {
                    Dashboard.hideLoadingMsg();
                    loadLocalModels();
                    loadAvailableModels();
                    loadStatus();
                    loadFormFromConfig();
                    Dashboard.alert('Model set as active and loaded!');
                }).catch(function(err) {
                    Dashboard.hideLoadingMsg();
                    loadStatus();
                    Dashboard.alert('Failed to set model: ' + (err.message || 'Unknown error'));
                });
            }

            function deleteModel(filename) {
                if (!confirm('Are you sure you want to delete this model?')) {
                    return;
                }

                ApiClient.ajax({
                    type: 'DELETE',
                    url: ApiClient.getUrl('LLMRenamer/Models/' + encodeURIComponent(filename))
                }).then(function() {
                    loadLocalModels();
                    loadAvailableModels();
                    loadStatus();
                    Dashboard.alert('Model deleted!');
                }).catch(function(err) {
                    Dashboard.alert('Failed to delete model: ' + (err.message || 'Unknown error'));
                });
            }

            function loadNativeStatus() {
                ApiClient.getJSON(ApiClient.getUrl('LLMRenamer/Native/Status')).then(function(status) {
                    var container = document.getElementById('nativeStatus');
                    var platformEl = document.getElementById('nativePlatform');
                    var statusTextEl = document.getElementById('nativeStatusText');
                    var pathInfoEl = document.getElementById('nativePathInfo');
                    var pathEl = document.getElementById('nativePath');
                    var actionsEl = document.getElementById('nativeActions');

                    platformEl.textContent = status.Platform;
                    pathEl.textContent = status.NativeDirectory;

                    if (status.IsInstalled) {
                        container.className = 'native-status installed';
                        statusTextEl.innerHTML = '<span style="color: #52b54b;">&#10003;</span> Installed (' + status.ExpectedFile + ')';
                        pathInfoEl.style.display = 'block';
                        actionsEl.style.display = 'none';
                    } else {
                        container.className = 'native-status missing';
                        statusTextEl.innerHTML = '<span style="color: #f2a83b;">&#9888;</span> Not installed - required for LLM inference';
                        pathInfoEl.style.display = 'none';
                        actionsEl.style.display = 'block';
                    }
                }).catch(function(err) {
                    document.getElementById('nativeStatusText').textContent = 'Error checking status';
                });
            }

            function downloadNativeLibraries() {
                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl('LLMRenamer/Native/Download')
                }).then(function() {
                    startProgressPolling();
                    Dashboard.alert('Native library download started');
                }).catch(function(err) {
                    Dashboard.alert('Failed to start download: ' + (err.message || 'Unknown error'));
                });
            }

            function loadFormFromConfig() {
                ApiClient.getPluginConfiguration(LLMRenamerConfig.pluginUniqueId).then(function (config) {
                    document.querySelector('#txtModelPath').value = config.ModelPath || '';
                    document.querySelector('#txtModelName').value = config.ModelName || '';
                    document.querySelector('#numGpuLayers').value = config.GpuLayerCount || 0;
                    document.querySelector('#numContextSize').value = config.ContextSize || 2048;
                    document.querySelector('#numMaxTokens').value = config.MaxTokens || 256;
                    document.querySelector('#chkPreviewOnly').checked = config.PreviewOnly !== false;
                    document.querySelector('#chkEnableAutoRename').checked = config.EnableAutoRename === true;
                    document.querySelector('#chkRenameDirectories').checked = config.RenameDirectories === true;
                    document.querySelector('#chkRenameMovies').checked = config.RenameMovies !== false;
                    document.querySelector('#chkRenameEpisodes').checked = config.RenameEpisodes !== false;
                    document.querySelector('#chkRenameMusic').checked = config.RenameMusic === true;
                    document.querySelector('#txtCustomPrompt').value = config.CustomPromptAdditions || '';
                    Dashboard.hideLoadingMsg();
                });
            }

            // Page load
            document.querySelector('#LLMRenamerConfigPage').addEventListener('pageshow', function () {
                Dashboard.showLoadingMsg();

                loadStatus();
                loadNativeStatus();
                loadAvailableModels();
                loadLocalModels();

                // Native library download button
                document.getElementById('btnDownloadNative').addEventListener('click', downloadNativeLibraries);

                // Check if download in progress
                ApiClient.getJSON(ApiClient.getUrl('LLMRenamer/Models/DownloadProgress')).then(function(progress) {
                    if (progress && progress.IsDownloading) {
                        updateProgressUI(progress);
                        startProgressPolling();
                    }
                });

                loadFormFromConfig();
            });

            // Page unload - stop polling
            document.querySelector('#LLMRenamerConfigPage').addEventListener('pagehide', function() {
                stopProgressPolling();
            });

            // Save form
            document.querySelector('#LLMRenamerConfigForm').addEventListener('submit', function (e) {
                e.preventDefault();
                Dashboard.showLoadingMsg();
                ApiClient.getPluginConfiguration(LLMRenamerConfig.pluginUniqueId).then(function (config) {
                    config.ModelPath = document.querySelector('#txtModelPath').value;
                    config.ModelName = document.querySelector('#txtModelName').value;
                    config.GpuLayerCount = parseInt(document.querySelector('#numGpuLayers').value, 10) || 0;
                    config.ContextSize = parseInt(document.querySelector('#numContextSize').value, 10) || 2048;
                    config.MaxTokens = parseInt(document.querySelector('#numMaxTokens').value, 10) || 256;
                    config.PreviewOnly = document.querySelector('#chkPreviewOnly').checked;
                    config.EnableAutoRename = document.querySelector('#chkEnableAutoRename').checked;
                    config.RenameDirectories = document.querySelector('#chkRenameDirectories').checked;
                    config.RenameMovies = document.querySelector('#chkRenameMovies').checked;
                    config.RenameEpisodes = document.querySelector('#chkRenameEpisodes').checked;
                    config.RenameMusic = document.querySelector('#chkRenameMusic').checked;
                    config.CustomPromptAdditions = document.querySelector('#txtCustomPrompt').value;
                    ApiClient.updatePluginConfiguration(LLMRenamerConfig.pluginUniqueId, config).then(function () {
                        Dashboard.processPluginConfigurationUpdateResult();
                        loadStatus();
                    });
                });
                return false;
            });

            // Cancel download
            document.querySelector('#btnCancelDownload').addEventListener('click', function() {
                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl('LLMRenamer/Models/CancelDownload')
                }).then(function() {
                    Dashboard.alert('Download cancelled');
                });
            });

            // Custom download
            document.querySelector('#btnDownloadCustom').addEventListener('click', function() {
                var url = document.getElementById('txtCustomUrl').value;
                var filename = document.getElementById('txtCustomFilename').value;

                if (!url || !filename) {
                    Dashboard.alert('Please enter both URL and filename');
                    return;
                }

                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl('LLMRenamer/Models/DownloadCustom'),
                    data: JSON.stringify({ Url: url, Filename: filename }),
                    contentType: 'application/json'
                }).then(function() {
                    document.getElementById('txtCustomUrl').value = '';
                    document.getElementById('txtCustomFilename').value = '';
                    startProgressPolling();
                }).catch(function(err) {
                    Dashboard.alert('Failed to start download: ' + (err.message || 'Unknown error'));
                });
            });

            // Test rename
            document.querySelector('#btnTest').addEventListener('click', function() {
                var filename = document.getElementById('txtTestFilename').value;
                if (!filename) {
                    Dashboard.alert('Please enter a filename to test');
                    return;
                }

                var btn = this;
                btn.disabled = true;
                btn.querySelector('span').textContent = 'Testing...';

                ApiClient.ajax({
                    type: 'POST',
                    url: ApiClient.getUrl('LLMRenamer/Test'),
                    data: JSON.stringify({ Filename: filename }),
                    contentType: 'application/json'
                }).then(function(result) {
                    var data = typeof result === 'string' ? JSON.parse(result) : result;
                    document.getElementById('testResult').style.display = 'block';
                    document.getElementById('testOriginal').textContent = data.OriginalFilename;
                    document.getElementById('testSuggested').textContent = data.SuggestedFilename;
                    btn.disabled = false;
                    btn.querySelector('span').textContent = 'Test Rename';
                }).catch(function(err) {
                    Dashboard.alert('Test failed: ' + (err.message || 'Make sure a model is configured'));
                    btn.disabled = false;
                    btn.querySelector('span').textContent = 'Test Rename';
                });
            });
        </script>
    </div>
</body>
</html>
